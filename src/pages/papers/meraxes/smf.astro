---
import MeraxesLayout from "../../../layouts/Meraxes.astro";
import DownloadButton from "../../../components/DownloadButton.astro";
---

<MeraxesLayout>
  <div class="prose mt-16">
    <h2>Galaxy stellar mass functions</h2>
    <h3>Fiducial model</h3>

    <div class="lg:flex lg:gap-16">
    <div id="plot"></div>

    <table>
      <thead>
        <tr>
          <th>Parameter</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>ùõÇ<sub>SF</sub></td>
          <td>0.03</td>
        </tr>
        <tr>
          <td>f<sub>esc</sub></td>
          <td>0.2</td>
        </tr>
        <tr>
          <td>cosmology</td>
          <td>Planck 2015</td>
        </tr>
        <tr>
          <td>h</td>
          <td>0.678</td>
        </tr>
        <tr>
          <td>volume</td>
          <td>100 Mpc<sup>3</sup></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="2" style="text-align: right;"
            >For more info see <a
              href="http://mnras.oxfordjournals.org/content/462/1/250.abstract"
              >the paper</a
            >.</td
          >
        </tr>
      </tfoot>
    </table>
    </div>
    <p>
      <strong>Note</strong>: Data is provided in HDF5 format with all units and
      required information provided as attributes.
    </p>
    <DownloadButton />
  </div>
</MeraxesLayout>

<!-- TODO: Replace this total mess of a plot with something more modern! -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"
  integrity="sha512-zInFF17qBFVvvvFpIfeBzo7Tj7+rQxLeTJDmbxjBz5/zIr89YVbTNelNhdTT+/DCrxoVzBeUPVFJsczKbB7sew=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>
<script
  src="https://cdn.jsdelivr.net/npm/underscore@1.13.6/underscore-umd-min.js"
></script>
<script src="https://cdn.plot.ly/plotly-1.2.1.min.js" charset="utf-8"></script>
<script>
  (function () {
    Plotly.d3.json("/data/meraxes/smf.json", function (data) {
      var mass = data.mass;
      data = _.omit(data, "mass");

      var lines = [];
      var nSnaps = _.keys(data).length;
      var colors = chroma
        .cubehelix()
        .start(190)
        .rotations(1.3)
        .gamma(0.7)
        .lightness([0.3, 0.8])
        .scale()
        .correctLightness()
        .colors(nSnaps);

      // sort by redshift
      var keys = _.keys(data);
      keys = _.sortBy(keys, function (key) {
        return Number(key.substr(1));
      });
      window.data = data;
      window.keys = keys;

      for (var ii = 0; ii < keys.length; ii++) {
        var key = keys[ii];

        if (data[key].xHI == 1000000.0) {
          data[key].xHI = "0";
        }

        lines.push({
          x: mass,
          y: data[key].phi,
          mode: "lines",
          name:
            "z=" +
            Number(key.substr(1)).toFixed(1) +
            " (xHI=" +
            Number(data[key].xHI).toFixed(1) +
            ")",

          line: {
            width: 4,
            color: colors[ii % colors.length],
          },
        });
      }

      var layout = {
        hovermode: "closest",
        margin: {
          t: 30,
        },
        yaxis: {
          type: "log",
          exponentformat: "e",
          showexponent: "all",
          title: "ùõü [dex<sup>-1</sup> Mpc<sup>-3</sup>]",
        },

        xaxis: {
          range: [5, 11.5],
          title: "log<sub>10</sub>(M<sub>*</sub>/M<sub>‚äô</sub>)",
        },
      };

      var plot = Plotly.plot(document.getElementById("plot"), lines, layout, {
        showLink: false,
      });
    });

    window.onresize = function () {
      Plotly.Plots.resize(plot);
    };
  })();
</script>
